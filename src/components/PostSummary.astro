---
import { marked } from 'marked';
import slugify from 'slugify';
import createStory from '../lib/createStory.ts';

export interface Props {
  story: Story;
  titleEl?: 'h1' | 'h2' | 'h3' | 'h4' | 'h5' | 'h6';
  showText?: boolean;
  showReplyBtn?: boolean;
  showRootTitle?: boolean;
  rootStoryID?: number|string;
  parentStoryID?: number|string;
  prevStoryID?: number|string;
  nextStoryID?: number|string;
  path?: string;
}

const getTitlePrefix = (story: Story) => {
  switch (story.type) {
    case 'ask':
      return 'Ask PHN: ';
    case 'show':
      return 'Show PHN: ';
    case 'job':
      return 'Job: ';
    default:
      return '';
  }
};

const {
  story: storyData,
  titleEl = 'h3',
  showText = false,
  showReplyBtn = false,
  rootStoryID,
  parentStoryID,
  showRootTitle,
  prevStoryID,
  nextStoryID,
  path,
} = Astro.props;
const story = createStory(storyData);
const currrentPath = path ?? Astro.url.pathname;
const Title = titleEl;
const storySlug = slugify(story.title, { lower: true });
---
<div class="postSummary" id={`post-${story.id}`}>
  <div class:list={['postSummary__header', { 'postSummary__header--noTitle': !story.title }]}>
    <div class="postSummary__title">
      <a href={`/vote/up/${story.id}?from=${currrentPath}`} class="postSummary__voteLink" data-astro-prefetch="false">
        <img src="/triangle.svg" alt="Vote up" width="13" height="13">
      </a>
      {story.title ? (
        <div class="postSummary__titleWrapper">
          <a href={story.url ? story.url : `/stories/${story.id}/${storySlug}`} target={story.url ? '_blank' : '_self'}>

            <Title>{getTitlePrefix(story)}{story.title}{story.url ? <i>â†—</i> : null}</Title>
          </a>
          {story.domain ? <a href={`/search?site=${story.domain}`} class="postSummary__domain">({story.domain})</a> : null}
        </div>
      ) : null}
    </div>
    <div class="postSummary__meta">
      {!Number.isNaN(story.score) ? <span>{story.score} {story.score === 1 ? 'point' : 'points'} by</span> : null}
      <a href={`/search?user=${story.by}`}>{story.by}</a>
      <a href={`/stories/${story.id}/${storySlug}`}>{story.time_ago} ago</a>
      {
        story.descendants > 0
          ? <span> | </span><a href={`/stories/${story.id}/${storySlug}`}>{story.descendants} {story.descendants === 1 ? 'comment' : 'comments'}</a>
          : null
      }
      {story.type !== 'comment' && story.url ? <span> | </span><a href={`/stories/${story.id}/${storySlug}`}>read post</a>: null}
      {rootStoryID ? <span> | </span><a href={`${currrentPath}#post-${rootStoryID}`}>root</a> : null}
      {parentStoryID ? <span> | </span><a href={`${currrentPath}#post-${parentStoryID}`}>parent</a> : null}
      {showRootTitle && story.root_id && story.root_title ? <span> | on: </span><a href={`/stories/${story.root_id}/${slugify(story.root_title, { lower: true })}#post-${story.id}`}>{story.root_title}</a> : null}
      {prevStoryID ? <span> | </span><a href={`${currrentPath}#post-${prevStoryID}`}>prev</a> : null}
      {nextStoryID ? <span> | </span><a href={`${currrentPath}#post-${nextStoryID}`}>next</a> : null}
    </div>
  </div>
  <div class="postSummary__body">
    <!-- TODO: DANGER! SANITIZE MARKDOWN OUTPUT -->
    {showText && story.text ? <div class="postSummary__text" set:html={marked.parse(story.text)}></div> : null}
    {showReplyBtn ? <div class="postSummary__replyLink"><a href={`/reply/${story.id}`}>reply</a></div> : null}
  </div>
</div>

<style>
  .postSummary {
    font-size: 12px;
  }

  .postSummary a {
    color: #828282;
  }

  .postSummary a:hover {
    text-decoration: underline;
  }

  .postSummary__header.postSummary__header--noTitle {
    display: flex;
  }

  .postSummary__title {
    display: flex;
  }

  .postSummary__voteLink {
    width: 13px;
    height: 13px;
  }

  .postSummary__titleWrapper {
    margin-left: 5px;
  }

  .postSummary__titleWrapper a:has(h3):hover {
    text-decoration: none;
  }

  .postSummary__titleWrapper h1,
  .postSummary__titleWrapper h2,
  .postSummary__titleWrapper h3,
  .postSummary__titleWrapper h4,
  .postSummary__titleWrapper h5,
  .postSummary__titleWrapper h6 {
    color: #000000;
    margin: 0;
    display: inline-block;
    vertical-align: middle;
    font-size: 15px;
    line-height: 16px;
    font-weight: normal;
  }

  .postSummary__titleWrapper h1 > i,
  .postSummary__titleWrapper h2 > i,
  .postSummary__titleWrapper h3 > i,
  .postSummary__titleWrapper h4 > i,
  .postSummary__titleWrapper h5 > i,
  .postSummary__titleWrapper h6 > i {
    font-size: 10px;
    display: inline-block;
    vertical-align: middle;
    border: 1px solid #828282;
    padding: 2px;
    line-height: 10px;
    border-radius: 3px;
    margin-left: 3px;
    color: #828282;
  }

  .postSummary__domain {
    font-size: 11px;
    display: inline-block;
    vertical-align: middle;
  }

  .postSummary__meta, .postSummary__text, .postSummary__replyLink {
    padding-left: 18px;
  }

  .postSummary__title:not(:has(.postSummary__titleWrapper)) {
    display: inline-block;
  }

  .postSummary__title:not(:has(.postSummary__titleWrapper)) + .postSummary__meta {
    display: inline-block;
    padding-left: 0;
  }

  .postSummary__header.postSummary__header--noTitle > .postSummary__meta {
    margin-left: 5px;
  }

  .postSummary__text {
    font-size: 13px;
    color: #828282;
  }

  :global(.postSummary__text > pre) {
    margin: 0;
    padding: 10px 0 5px;
    white-space: pre-wrap;
  }

  .postSummary__replyLink > a {
    font-size: 10px;
    text-decoration: underline;
  }
</style>

