---
import StoriesRepository from '../../repositories/Stories';
import MainLayout from '../../layouts/main.astro';
import Error from '../../components/Error.astro';
import MainStoryContainer from '../../components/MainStoryContainer.astro';
import PostSummary from '../../components/PostSummary.astro';
import CommentForm from '../../components/CommentForm.astro';
import CommentTimeline from '../../components/CommentTimeline.astro';

const {locals: { db, user }, params, url } = Astro;
const storiesRepo = new StoriesRepository(db);
const id = parseInt(params.slug.split('/')[0], 10);

const story = await storiesRepo.getById(id);

const comments = await storiesRepo.getDescendantsByParentId(id);

const storiesDB = comments
  .concat([story])
  .reduce((acc, story, _, allComments) => {
    story.kids = allComments.reduce((acc, comment) => {
      if (comment.parent_id === story.id) {
        acc.push(comment.id);
      }
      return acc;
    }, []);
    acc[story.id] = story;
    return acc;
  }, {});

story.descendants = comments.length;

const flashErrorVote = Astro.cookies.get('flash_error_vote')?.value;
---
<MainLayout title={`Product Hacker News | ${story.title}`}>
  <script slot="head" type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "DiscussionForumPosting",
    "mainEntityOfPage": url.href,
    "headline": story.title,
    "text": story.text,
    "url": url.href,
    "author": {
      "@type": "Person",
      "name": story.by
    },
    "datePublished": new Date(story.created_at + '.000Z').toISOString(),
    "interactionStatistic": story.score >= 0 ? {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/LikeAction",
      "userInteractionCount": story.score
    } : {
      "@type": "InteractionCounter",
      "interactionType": "https://schema.org/DislikeAction",
      "userInteractionCount": story.score * -1
    },
    "comments": comments.map(comment => ({
      "@type": "Comment",
      "text": comment.text,
      "author": {
        "@type": "Person",
        "name": comment.by
      },
      "datePublished": new Date(comment.created_at + '.000Z').toISOString(),
      "interactionStatistic": comment.score >= 0 ? {
        "@type": "InteractionCounter",
        "interactionType": "https://schema.org/LikeAction",
        "userInteractionCount": comment.score
      } : {
        "@type": "InteractionCounter",
        "interactionType": "https://schema.org/DislikeAction",
        "userInteractionCount": comment.score * -1
      }
    }))
  })}></script>
  {flashErrorVote && <Error>{flashErrorVote}</Error>}
  <MainStoryContainer>
    <PostSummary story={story} titleEl="h1" showText />
    {user ? <CommentForm parentID={story.id} rootID={story.id} /> : null}
    <CommentTimeline items={story.kids ?? []} getItem={id => storiesDB[id]} />
  </MainStoryContainer>
</MainLayout>
