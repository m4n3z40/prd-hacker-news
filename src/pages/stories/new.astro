---
import slugify from 'slugify';
import StoriesRepository from "../../repositories/Stories";

const { loggedIn, db, user } = Astro.locals;

if (!loggedIn) {
  return Astro.redirect('/login', 302);
}

try {
  const storiesRepo = new StoriesRepository(db);
  const from = Astro.url.searchParams.get('from');

  const formData = await Astro.request.formData();

  const title = formData.get('title') as string;
  const url = formData.get('url') as string;
  const text = formData.get('text') as string;
  const type = formData.get('type') as string as PostType || 'post';
  const parentID = parseInt(formData.get('parentId') as string, 10) || null;

  const story = await storiesRepo.create({
    title: title || '',
    url,
    text,
    type,
    user_id: user.id,
    parent_id: parentID,
  } as Story);

  return Astro.redirect(from || `/stories/${story.id}/${slugify(story.title, { lower: true })}`);
} catch (error) {
  console.error(error);

  Astro.cookies.set('flash_error', 'Could not submit post. Try again later.', { maxAge: 1, path: '/submit' });

  return Astro.redirect('/submit');
}
---
