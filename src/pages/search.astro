---
import MainLayout from '../layouts/main.astro';
import Error from '../components/Error.astro';
import PostSummary from '../components/PostSummary.astro';

const { repositories: { stories:storiesRepo } } = Astro.locals;
const by = Astro.url.searchParams.get('user');
const domain = Astro.url.searchParams.get('site');
const q = Astro.url.searchParams.get('q');
const page = parseInt(Astro.url.searchParams.get('page') || '1', 10);
const perPage = 30;
let stories:Story[] = [];

const totalCount = await storiesRepo.countAll({ by, domain, title: q });

if (totalCount > 0) {
  stories = await storiesRepo.getAll({ by, domain, title: q, page, perPage });
}

const flashErrorVote = Astro.cookies.get('flash_error_vote')?.value;
---
<MainLayout>
  {flashErrorVote && <Error>{flashErrorVote}</Error>}
  <ol class="storiesTimeline">
    {stories.map(story => (
      <li class="storyItem">
        <PostSummary story={story as unknown as Story} />
      </li>
    ))}
  </ol>
  {page * perPage <= totalCount && (
    <div class="moreLink">
      <a href={`/?page=${page + 1}${by ? `&user=${by}` : ''}${domain ? `&site=${domain}` : ''}${q ? `&q=${q}` : ''}`}>More</a>
    </div>
  )}
</MainLayout>

<style>
  .storiesTimeline {
    margin: 0;
    padding-left: 40px;
    margin-bottom: 15px;
  }

  .storiesTimeline > li::marker {
    font-size: 15px;
  }

  .storiesTimeline > li:not(:last-child) {
    margin-bottom: 7px;
  }

  .moreLink {
    margin-left: 48px;
  }

  .moreLink > a {
    color: #828282;
    font-size: 15px;
  }
</style>
