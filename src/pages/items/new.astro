---
const { loggedIn, db, user } = Astro.locals;

if (!loggedIn) {
  return Astro.redirect('/login', 302);
}

try {
  const searchParams = Astro.url.searchParams;
  const formData = await Astro.request.formData();

  const title = formData.get('title') as string;
  const url = formData.get('url') as string;
  const domain = url ? new URL(url).hostname : null;
  const text = formData.get('text') as string;
  const type = formData.get('type') as string || 'post';
  const parentID = formData.get('parentId') as string ?? null;

  const { lastInsertRowid } = await db.execute({
    sql: 'INSERT INTO stories (title, url, domain, text, type, user_id, parent_id) VALUES (?, ?, ?, ?, ?, ?, ?)',
    args: [title || '', url, domain, text, type, user.id, parentID],
  });

  return Astro.redirect(`/items/${parentID || lastInsertRowid}`);
} catch (error) {
  console.error(error);

  Astro.cookies.set('flash_error', 'Could not submit post. Try again later.', { maxAge: 1, path: '/submit' });

  return Astro.redirect('/submit');
}
---
