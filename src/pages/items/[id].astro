---
import MainLayout from '../../layouts/main.astro';
import Error from '../../components/Error.astro';
import MainStoryContainer from '../../components/MainStoryContainer.astro';
import PostSummary from '../../components/PostSummary.astro';
import CommentForm from '../../components/CommentForm.astro';
import CommentTimeline from '../../components/CommentTimeline.astro';

const { db, user } = Astro.locals;
const { id } = Astro.params;

const resS = await db.execute({
  sql: `SELECT s.*, u.username AS by, COALESCE(SUM(v.weight), 0) AS score
FROM stories s
JOIN users u ON s.user_id = u.id
LEFT JOIN story_votes v ON s.id = v.story_id
WHERE s.id = ?`,
  args: [id],
});
const story = resS.rows[0] as unknown as Story;

const resC = await db.execute({
  sql: `WITH descendants as (
  SELECT s.id, s.parent_id
  FROM stories s
  WHERE s.parent_id = ?
  UNION ALL
  SELECT sc.id, sc.parent_id
  FROM stories sc
  INNER JOIN descendants d ON d.id = sc.parent_id
)
SELECT s.*, u.username AS by, COALESCE(SUM(v.weight), 0) AS score
FROM stories s
JOIN users u ON s.user_id = u.id
LEFT JOIN story_votes v ON s.id = v.story_id
WHERE s.id IN (SELECT id FROM descendants)
GROUP BY s.id`,
  args: [id],
});
const comments = resC.rows as unknown as Story[];

const storiesDB = comments
  .concat([story])
  .reduce((acc, story, _, allComments) => {
    story.kids = allComments.reduce((acc, comment) => {
      if (comment.parent_id === story.id) {
        acc.push(comment.id);
      }
      return acc;
    }, []);
    acc[story.id] = story;
    return acc;
  }, {});

story.descendants = comments.length;

const flashErrorVote = Astro.cookies.get('flash_error_vote')?.value;
---
<MainLayout title={`Product Hacker News | ${story.title}`}>
  {flashErrorVote && <Error>{flashErrorVote}</Error>}
  <MainStoryContainer>
    <PostSummary story={story} showText />
    {user ? <CommentForm parentID={story.id} rootID={story.id} /> : null}
    <CommentTimeline items={story.kids ?? []} getItem={id => storiesDB[id]} />
  </MainStoryContainer>
</MainLayout>
